---
layout: post
title: redis 성능 개선
excerpt_separator:  <!--more-->
---
# 레디스 성능개선 
<span style="color:#e11d21">일단 sandbox 에서 현재 성능을 테스트 할 수 있는 환경을 만들어보자. 

테스트용 api 
    /greetings
테스트용 redis key
    /greetings
gatling script 
</span>


레디스에서는 redis-benchmark 라는 성능테스트 툴을 제공한다.
알파 레디스 에서 테스트 
```
./redis-benchmark -n 1000
```

- result 
```
====== SET ======
  1000 requests completed in 0.01 seconds
  50 parallel clients
  3 bytes payload
  keep alive: 1

100.00% <= 0 milliseconds
124999.99 requests per second

====== GET ======
  1000 requests completed in 0.01 seconds
  50 parallel clients
  3 bytes payload
  keep alive: 1

100.00% <= 0 milliseconds
142857.14 requests per second
```

리얼 레디스에서 테스트 

```
./redis-benchmark -n 1000
```

- result 
```
====== SET ======
  1000 requests completed in 0.01 seconds
  50 parallel clients
  3 bytes payload
  keep alive: 1

100.00% <= 1 milliseconds
90909.09 requests per second

====== GET ======
  1000 requests completed in 0.01 seconds
  50 parallel clients
  3 bytes payload
  keep alive: 1

99.90% <= 1 milliseconds
100.00% <= 1 milliseconds
90909.09 requests per second
```


레디스 현재 상태
```
./redis-cli -p 6379 --stat
```
```
------- data ------ --------------------- load -------------------- - child -
keys       mem      clients blocked requests            connections
2643       3.15M    6       0       103749837 (+0)      4125
2643       3.15M    6       0       103749839 (+2)      4125
2643       3.15M    6       0       103749843 (+4)      4125
```


레디스 정보 
```
./redis-cli info
```
```
# Server
redis_version:3.2.8
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:35a72952f00ac60d
redis_mode:standalone
os:Linux 2.6.32-642.15.1.el6.x86_64 x86_64
arch_bits:64
multiplexing_api:epoll
gcc_version:4.4.7
process_id:17896
run_id:1dbeb1a1f90e3724ee50237d4822732d3c72f6bf
tcp_port:6379
uptime_in_seconds:40516776
uptime_in_days:468
hz:10
lru_clock:6081981
executable:/home1/irteam/apps/redis-3.2.8/src/./redis-server
config_file:/home1/irteam/apps/redis-3.2.8/6379.conf

# Clients
connected_clients:18
client_longest_output_list:0
client_biggest_input_buf:0
blocked_clients:0

# Memory
used_memory:4656168
used_memory_human:4.44M
used_memory_rss:7204864
used_memory_rss_human:6.87M
used_memory_peak:7664464
used_memory_peak_human:7.31M
total_system_memory:8254717952
total_system_memory_human:7.69G
used_memory_lua:38912
used_memory_lua_human:38.00K
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
mem_fragmentation_ratio:1.55
mem_allocator:jemalloc-4.0.3

# Persistence
loading:0
rdb_changes_since_last_save:238
rdb_bgsave_in_progress:0
rdb_last_save_time:1549585698
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:0
rdb_current_bgsave_time_sec:-1
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok

# Stats
total_connections_received:4527198
total_commands_processed:235792888
instantaneous_ops_per_sec:3
total_net_input_bytes:32415158202
total_net_output_bytes:178855955138
instantaneous_input_kbps:0.16
instantaneous_output_kbps:0.18
rejected_connections:0
sync_full:2
sync_partial_ok:0
sync_partial_err:0
expired_keys:1174911
evicted_keys:0
keyspace_hits:40005774
keyspace_misses:800324
pubsub_channels:1
pubsub_patterns:0
latest_fork_usec:369
migrate_cached_sockets:0

# Replication
role:master
connected_slaves:1
slave0:ip=10.161.240.158,port=6380,state=online,offset=23632413966,lag=0
master_repl_offset:23632413966
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:23631365391
repl_backlog_histlen:1048576

# CPU
used_cpu_sys:18895.53
used_cpu_user:23101.55
used_cpu_sys_children:198.81
used_cpu_user_children:800.28

# Cluster
cluster_enabled:0

# Keyspace
db0:keys=2643,expires=609,avg_ttl=139619904

```


일단 우리 로직 적인 문제 부터 수정
- [NCP/643 레디스 리퀘스트 분석 공유](dooray://1387695619080878080/tasks/2410062148386844646 "working")



~~RedisReplication 에서  master slave 로의 커넥션 풀을 만들어주려면 직접 구현해야하는 방법밖에는 답이 없는듯 하다.~~
~~(ReplicationDataSource 처럼) ~~
~~근데 지금 시점에서 1.5 기반의 jedis를 개선하는게 맞는가 아니면, lettuce로 변경해서 개발하는게 맞는가? ~~
get/set으로 나누고 get일때는 slave 를 바라보도록 수정 해야함.
방법이 있다 
https://redis.io/topics/sentinel-clients
클라이언트가 센티넬에 붙는 방법인듯

lettuce 를 사용하면 금방 되는데.. 
ncp 에서 lettuce 를 사용하려면 변경되는게 너무 많다..
 일단 해보자..
 
 
 spring data commons가 2.1버전으로 업그레이드 되어 바뀌는게 많다..
 findone -> getOne
 delete -> deleteById, deleteAll
save -> saveAll, saveAllById 

passwordEncoder 도 없어졌구나
jasypt 를 변경을 해야하네

password 인코딩 된 문자열 테스트
인코딩된 문자열 생성
```
PDm2v1TnNBhqs1UO+24mtaksLoAqZfAYfg43BSQ5ycrz1U4+DXFo1NNRT/CPaBhE
```
Bcrypt로 변경 할 필요는 없고 
jasypt 에서 잘못 참조하고 잇는부분만 재구현 해주자



# 참고 
https://www.letmecompile.com/redis-cluster-sentinel-overview/





